trigger:
  branches:
    include:
      - main
  paths:
    include:
      - /TFAZLABRO/variables.tf
      - /TFAZLABRO/main.tf

jobs:
- job: TerraformJob
  displayName: 'Terraform Deployment'
  pool:
    vmImage: 'ubuntu-latest'

  variables:
    - group: hawaVB
  
  steps:
    - checkout: self
    
    - bash: |
        echo "ARM_CLIENT_ID=$(SPNPass)" >> $GITHUB_ENV
        echo "ARM_CLIENT_SECRET=$(SASPass)" >> $GITHUB_ENV
        echo "ARM_TENANT_ID=$(tenant_id)" >> $GITHUB_ENV
        echo "ARM_SUBSCRIPTION_ID=$(subscription_id)" >> $GITHUB_ENV
      displayName: 'Set Azure Service Principal Credentials'
    
    - script: |
        sudo apt-get update
        sudo apt-get install -y jq

        echo "##vso[task.setvariable variable=storage_account_SASPass;isOutput=true]$(terraform output -raw outputvar)"
        echo "##vso[task.setvariable variable=pass_tfazsp;isOutput=true]$(terraform output -raw outputvar)"
        echo "##vso[task.setvariable variable=appid_tfazsp;isOutput=true]$(terraform output -raw outputvar)"
      displayName: 'Get Terraform Outputs'

    - script: |
        az login --service-principal -u $SPNPass -p $SASPass --tenant $tenant_id
      displayName: 'Log Into Azure'

    - script: |
        cd $(System.DefaultWorkingDirectory)/TFAZLABRO
        terraform init -backend-config=resource_group_name=$(rg_name) \
          -backend-config="storage_account_name=$(storageAccount_name)" \
          -backend-config="container_name=$(cont_name)" \
          -backend-config="access_key=$(storage_account_SASPass)" \
          -backend-config="key=$(state_file)"
        terraform plan -var="appid_tfazsp=$(SPNPass)" \
          -var="pass_tfazsp=$(SASPass)" \
          -var="tenant_id=$(tenant_id)" \
          -var="subscription_id=$(subscription_id)" \
          -var="VMAdminPass=$(VMAdminPass)" \
          -out="out.plan"
        terraform apply "out.plan"
      displayName: 'Terraform Init, Plan, and Apply'